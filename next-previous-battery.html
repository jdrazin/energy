<html>
    <head>
    <meta http-equiv="refresh" content="30">
    <!--Load the AJAX API-->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">                                       // see https://www.digitalocean.com/community/tutorials/how-to-use-the-javascript-fetch-api-to-get-data
        const SERVER = 'http://192.168.1.15/';
        google.charts.load('current', {'packages':['corechart', 'table']});        // load the Visualization API and corechart package
        google.charts.setOnLoadCallback(fetchTimeSeries);                       // Set a callback to run when the Google Visualization API is loaded
        function fetchTimeSeries() {
            fetch(SERVER + 'slots')
                .then(response => response.text()) // First get response as text
                .then(text => {
                    if (!text) throw new Error("Empty response from server");
                    return JSON.parse(text);
                })
                .then(data => drawChart(data))
                .catch(error => console.error('Error fetching data:', error));
        }
        function fetchTariffCombinations() {
            fetch(SERVER + 'tariff_combinations')
                .then(response => response.text()) // First get response as text
                .then(text => {
                    if (!text) throw new Error("Empty response from server");
                    return JSON.parse(text);
                })
                .then(data => drawTable(data))
                .catch(error => console.error('Error fetching data:', error));
        }
        function drawChart(data) {
            var timeSeries = new google.visualization.DataTable(data);
                timeSeries.addColumn('date',   'Time of day');
                timeSeries.addColumn('number', 'NEXT load_house_kw');
                timeSeries.addColumn('number', 'PREV load_house_kw');
                timeSeries.addColumn('number', 'NEXT grid_kw');
                timeSeries.addColumn('number', 'PREV grid_kw');
                timeSeries.addColumn('number', 'NEXT solar_kw');
                timeSeries.addColumn('number', 'PREV solar_kw');
                timeSeries.addColumn('number', 'NEXT battery %');
                timeSeries.addColumn('number', 'PREV battery %');
            var row;
            for (var item = 1; item < data.length; item++) {
                row = data[item];
                timeSeries.addRow([new Date(1000*row[0]), row[1], row[2], row[3], row[4], row[5], row[6], row[7], row[8]]);
            }
            var options = {
                title: 'Previous and next 24hrs',
                titleTextStyle: { color: 'black', fontSize: 30, bold: true, italic: false},
                width: 1800,
                height: 800,
                backgroundColor: '#EEEEEE',
                series: {
                    0: { lineWidth: 5, axis: 'kilowatts'},  // total_load_kw
                    1: { lineWidth: 2, axis: 'kilowatts'},  // PREV total_load_kw
                    2: { lineWidth: 5, axis: 'kilowatts'},  // grid_kw
                    3: { lineWidth: 2, axis: 'kilowatts'},  // PREV grid_kw
                    4: { lineWidth: 5, axis: 'kilowatts'},  // solar_kw
                    5: { lineWidth: 2, axis: 'kilowatts'},  // PREV solar_kw
                    6: { lineWidth: 5, axis: 'battery'},    // battery_percent
                    7: { lineWidth: 2, axis: 'battery'},    // PREV battery_percent
                },
                axes: {
                    y: {
                        kilowatts:      {label: 'kilowatts (kW)'},
                        battery:        {label: 'Battery (%)'}
                    }
                },
                colors: [
                            '#4fbba9',    // total_load_kw
                            '#4fbba9',    // PREV total_load_kw
                            '#e02f25',    // grid_kw
                            '#e02f25',    // PREV grid_kw
                            '#e49307',    // solar_kw
                            '#e49307',    // PREV solar_kw
                            '#000000',    // solar_kw
                            '#000000'     // PREV solar_kw
                        ],
                is3D: true,
                hAxis:	{
                    title: 'slot start times',
                    titleTextStyle: { color: 'black', fontSize: 25, bold: true, italic: false},
                    textStyle : {fontSize: 20, bold: false},
                    format: 'HH:mm',
                    gridlines: {count: 24}
                },
                vAxis:	{
                    titleTextStyle: { color: 'black', fontSize: 25, bold: true, italic: false},
                    textStyle : {fontSize: 20, bold: false},
                    gridlines: {color: 'none'},
                    minValue: 0
                },
            };
            /*
             * Google Line Chart curve fitting is rubbish, so consider cubic splines for future
             * see Python scipy/numpy library: https://pythonnumericalmethods.studentorg.berkeley.edu/notebooks/chapter17.03-Cubic-Spline-Interpolation.html
             */
            var chart = new google.visualization.LineChart(document.getElementById('chart_time_series'));
            chart.draw(timeSeries, options);
        }
        /*
         * table: tariff combinations, see https://developers.google.com/chart/interactive/docs/gallery/table
         */
        google.charts.setOnLoadCallback(fetchTariffCombinations);

        function drawTable(data) {
            var tariffCombinations = new google.visualization.DataTable();
                tariffCombinations.addColumn('datetime',    'Starting');
                tariffCombinations.addColumn('string',      'Tariff combination [import, export]');
                tariffCombinations.addColumn('string',      'Result');
                tariffCombinations.addColumn('number',      'Grid: raw (GBP)');
                tariffCombinations.addColumn('number',      'Grid: optimised (GBP)');
                tariffCombinations.addColumn('number',      'Grid: saving (GBP)');
                tariffCombinations.addColumn('number',      'Net saving (GBP)');
                tariffCombinations.addColumn('number',      'Grid: saving (%)');
                tariffCombinations.addColumn('number',      'Wear (%)');
            var row;
            for (var item = 1; item < data.length; item++) {
                row = data[item];
                tariffCombinations.addRow([new Date(1000*row[0]), row[1], row[2], row[3], row[4], row[5], row[6], row[7], row[8]]);
            }
            var table = new google.visualization.Table(document.getElementById('table_tariff_combinations'));
            var options = {
                showRowNumber: true,
                page: 'enable',
                pageSize: 6,
                pagingButtons: 'both',
                width: 1800,
                height: 150 + (80 * data.length)
            }
            table.draw(tariffCombinations, options);
        }
    </script>
</head>
<body>
    <div id="chart_time_series"></div>
    <div id="table_tariff_combinations"></div>
</body>
</html>
