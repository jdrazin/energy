<html>
<head>
    <meta http-equiv="refresh" content="30">
    <!--Load the AJAX API-->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">                                       // see https://www.digitalocean.com/community/tutorials/how-to-use-the-javascript-fetch-api-to-get-data
        google.charts.load('current', {'packages':['corechart']});        // load the Visualization API and corechart package
        /*
         * plot: next/previous day time series
         */
        google.charts.setOnLoadCallback(fetchTimeSeries);                       // Set a callback to run when the Google Visualization API is loaded
        function fetchTimeSeries() {
            fetch('http://192.168.1.14/slots')
                .then(response => response.text()) // First get response as text
                .then(text => {
                    if (!text) throw new Error("Empty response from server");
                    return JSON.parse(text);
                })
                .then(data => drawChart(data))
                .catch(error => console.error('Error fetching data:', error));
        }
        function drawChart(data) {
            var timeSeries = new google.visualization.DataTable();
                timeSeries.addColumn('date',   'Time of day');
                timeSeries.addColumn('number', 'total_load_kw');
                timeSeries.addColumn('number', 'PREV total_load_kw');
                timeSeries.addColumn('number', 'grid_kw');
                timeSeries.addColumn('number', 'PREV grid_kw');
                timeSeries.addColumn('number', 'solar_kw');
                timeSeries.addColumn('number', 'PREV solar_kw');
            var row;
            for (var item = 1; item < data.length; item++) {
                row = data[item];
                timeSeries.addRow([new Date(1000*row[0]), row[1], row[2], row[3], row[4], row[5], row[6]]);
            }
            var options = {
                title: 'Next and previous 24hrs',
                titleTextStyle: { color: 'black', fontSize: 30, bold: true, italic: false},
                width: 1800,
                height: 800,
                backgroundColor: '#EEEEEE',
                lineWidth: 5,
                series: {
                    0: { lineWidth: 5 },  // total_load_kw
                    1: { lineWidth: 2 },  // PREV total_load_kw
                    2: { lineWidth: 5 },  // grid_kw
                    3: { lineWidth: 2 },  // PREV grid_kw
                    4: { lineWidth: 5 },  // solar_kw
                    5: { lineWidth: 2 },  // PREV solar_kw
                },
                colors: [
                            '#4fbba9',    // total_load_kw
                            '#4fbba9',    // PREV total_load_kw
                            '#e02f25',    // grid_kw
                            '#e02f25',    // PREV grid_kw
                            '#e49307',    // solar_kw
                            '#e49307'     // PREV solar_kw
                        ],
                is3D: false,
                hAxis:	{
                    title: 'slot start times',
                    titleTextStyle: { color: 'black', fontSize: 25, bold: true, italic: false},
                    textStyle : {fontSize: 20, bold: false},
                    format: 'HH:mm',
                    gridlines: {count: 24}
                },
                vAxis:	{
                    title: 'kilowatts (kW)',
                    titleTextStyle: { color: 'black', fontSize: 25, bold: true, italic: false},
                    textStyle : {fontSize: 20, bold: false},
                    gridlines: {color: 'none'},
                    minValue: 0
                }
            };
            var chart = new google.visualization.LineChart(document.getElementById('chart_time_series'));
            chart.draw(timeSeries, options);
        }
        /*
         * table: tariff combinations
         */
        google.charts.setOnLoadCallback(fetchTariffCombinations);
        function fetchTariffCombinations() {
            fetch('http://192.168.1.14/tariff_combinations')
                .then(response => response.text()) // First get response as text
                .then(text => {
                    if (!text) throw new Error("Empty response from server");
                    return JSON.parse(text);
                })
                .then(data => drawTable(data))
                .catch(error => console.error('Error fetching data:', error));
        }
        function drawTable(data) {
            var tariffCombinations = new google.visualization.DataTable();
                tariffCombinations.addColumn('date',   'Starting');
                tariffCombinations.addColumn('string', 'Tariff combination [import, export]');
                tariffCombinations.addColumn('number', 'Raw GBP');
                tariffCombinations.addColumn('number', 'Optimised GBP');
                tariffCombinations.addColumn('number', 'Grid saving GBP');
                tariffCombinations.addColumn('number', 'Total saving GBP');
                tariffCombinations.addColumn('number', 'Saving %');
                tariffCombinations.addColumn('number', 'Wear %');
            var row;
            for (var item = 1; item < data.length; item++) {
                row = data[item];
                tariffCombinations.addRow([new Date(1000*row[0]), row[1], row[2], row[3], row[4], row[5], row[6], row[7]]);
            }
            var table = new google.visualization.Table(document.getElementById('table_tariff_combinations'));
            table.draw(tariffCombinations, {showRowNumber: true, width: '100%', height: '100%'});
        }
    </script>
</head>
<body>
<div id="chart_time_series"></div>
<div id="chart_tariff_combinations"></div>
</body>
</html>
